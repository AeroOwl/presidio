parameters:
  registry_parameter: ''
  registry_name_parameter: ''
  deps_label_parameter: ''
steps:
- bash: |
    if [ $DEPS_LABEL_TAG = "(dependency_label)"  ]; then
      echo '##vso[task.setvariable variable=deps_label]$(DEFAULT_DEPS_LABEL)' 
      echo 'deps label is empty, setting to default'
    else
      echo '##vso[task.setvariable variable=deps_label]$(DEPS_LABEL_TAG)' 
      echo 'deps label is not empty:' $DEPS_LABEL_TAG
    fi
  displayName: 'Setup deps label if empty'
  env:
    DEPS_LABEL_TAG: ${{ parameters.deps_label_parameter }}
- task: Docker@2
  inputs:
    containerRegistry: ${{ parameters.registry_parameter }}
    command: 'login'
- bash: |
    mkdir -p '$(GOBIN)'
    mkdir -p '$(GOPATH)/pkg'
    mkdir -p '$(MODULEPATH)'
    shopt -s extglob
    mv !(gopath) '$(MODULEPATH)'
    echo '##vso[task.prependpath]$(GOBIN)'
    echo '##vso[task.prependpath]$(GOROOT)/bin'
  displayName: 'Setup Go Env'
- bash: |
    curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
    dep ensure      
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildID) PRESIDIO_DEPS_LABEL=$DEPS_LABEL_TAG test-functional
  env:
    REGISTRY_NAME: ${{ parameters.registry_name_parameter }}
    DEPS_LABEL_TAG: $(deps_label)
  workingDirectory: '$(MODULEPATH)'
  displayName: 'Build & Test '
- task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
  displayName: 'OSS Component Detection'
  continueOnError: true

### pushing and publishing on non PR only
- task: CopyFiles@2
  displayName: 'Copy Chart to Artifact Staging Directory'
  condition: ne(variables['Build.Reason'], 'PullRequest')
  inputs:
    Contents: '**/presidio/charts/**'
    TargetFolder: charts
    CleanTargetFolder: true
    flattenFolders: true
- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: dropchart'
  condition: ne(variables['Build.Reason'], 'PullRequest')
  inputs:
    PathtoPublish: charts
    ArtifactName: dropchart  

- bash: | 
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildID) docker-push
  env:
    REGISTRY_NAME: ${{ parameters.registry_name_parameter }}
  displayName: 'Push Docker Images - BuildId label'    # push with build-id label - all branches  
  condition: ne(variables['Build.Reason'], 'PullRequest')
- bash: |
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildID) PRESIDIO_DEPS_LABEL=$(DEPS_LABEL_TAG) docker-push-latest-deps
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildId) RELEASE_VERSION='$(RELEASE_NAME)' docker-push-release                    
  env:
    REGISTRY_NAME: ${{ parameters.registry_name_parameter }}
    DEPS_LABEL_TAG: $(deps_label)
  displayName: 'Push Docker Images - Master Branch'    # push with latest label - master branch 
  condition: and( ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranchName'], 'master'))

- bash: | 
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildID) PRESIDIO_DEPS_LABEL=$(DEPS_LABEL_TAG) docker-push-latest-dev-deps
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildId) docker-push-latest-dev      
  env:
    REGISTRY_NAME: ${{ parameters.registry_name_parameter }}
    DEPS_LABEL_TAG: $(deps_label)
  displayName: 'Push Docker Images - Development Branch'    # push with latest-dev label - development branch
  condition:  and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranchName'], 'development'))

- bash: | 
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildID) PRESIDIO_DEPS_LABEL=$(DEPS_LABEL_TAG) PRESIDIO_BRANCH_LABEL=$(Build.SourceBranchName) docker-push-latest-branch-deps
    make DOCKER_REGISTRY=$REGISTRY_NAME PRESIDIO_LABEL=$(Build.BuildID) PRESIDIO_DEPS_LABEL=$(DEPS_LABEL_TAG) PRESIDIO_BRANCH_LABEL=$(Build.SourceBranchName) push-latest-branch
  env:
    REGISTRY_NAME: ${{ parameters.registry_name_parameter }}
    DEPS_LABEL_TAG: $(deps_label)
  displayName: 'Push Docker Images - Feature Branch'    # push with branch-name label - feature branch
  condition: and(ne(variables['Build.Reason'], 'PullRequest'), and(ne(variables['Build.SourceBranchName'], 'development'), ne(variables['Build.SourceBranchName'], 'master')))